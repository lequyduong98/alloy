services:
  # 1. STORAGE: MinIO (Bộ lưu trữ đối tượng cho Mimir, Loki, Tempo)
  minio:
    image: minio/minio:latest
    container_name: minio
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    restart: unless-stopped
    networks:
      - observ-net
  # 1.5. INIT: Service Khởi tạo MinIO Buckets
  init-minio:
    image: minio/mc:latest
    container_name: init-minio
    entrypoint: >
      /bin/sh -c "
      until (/usr/bin/mc alias set myminio http://minio:9000 minioadmin minioadmin) do echo 'Waiting for MinIO...' && sleep 1; done;
      /usr/bin/mc mb myminio/mimir-bucket --ignore-existing;
      /usr/bin/mc mb myminio/loki-bucket --ignore-existing;
      /usr/bin/mc mb myminio/tempo-bucket --ignore-existing;
      exit 0;
      "
    depends_on:
      minio:
        condition: service_healthy # Đợi cho đến khi healthcheck của minio thành công
    networks:
      - observ-net
  # 2. BACKEND: Grafana Mimir (Metrics Storage - Monolithic)
  mimir:
    image: grafana/mimir:latest
    container_name: mimir
    ports:
      - "9009:9009" # Cổng Remote Write và Truy vấn
    volumes:
      - ./config/mimir-config.yaml:/etc/mimir/mimir-config.yaml
      - /etc/localtime:/etc/localtime:ro
    environment:
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
      TZ: Asia/Ho_Chi_Minh # Thêm dòng này
    command:
      - --config.file=/etc/mimir/mimir-config.yaml
      - --target=all # Chế độ Monolithic
    depends_on:
      - minio
      - init-minio # Thêm phụ thuộc vào service khởi tạo
    restart: unless-stopped
    networks:
      - observ-net
  # 3. BACKEND: Grafana Loki (Logs Storage - Monolithic)
  loki:
    image: grafana/loki:latest
    container_name: loki
    ports:
      - "3100:3100" # Cổng Logs Ingestion (Promtail/Alloy Write)
    volumes:
      - ./config/loki-config.yaml:/etc/loki/loki-config.yaml
      - /etc/localtime:/etc/localtime:ro
    environment:
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
      TZ: Asia/Ho_Chi_Minh # Thêm dòng này
    command: 
      - --config.file=/etc/loki/loki-config.yaml
    depends_on:
      - minio
      - init-minio # Thêm phụ thuộc vào service khởi tạo
    restart: unless-stopped
    networks:
      - observ-net

  # 4. BACKEND: Grafana Tempo (Traces Storage)
  tempo:
    image: grafana/tempo:latest
    container_name: tempo
    ports:
      # OTLP Ingestion ports
      - "4317:4317" # OTLP gRPC
      - "4318:4318" # OTLP HTTP
      # Query ports (Grafana truy vấn từ đây)
      - "3200:3200" # Tempo HTTP/Thrift/UI
      - "9095:9095" # Tempo HTTP/Thrift/UI
      - "7946:7946"
    volumes:
      - ./config/tempo-config.yaml:/etc/tempo/tempo-config.yaml
      - /etc/localtime:/etc/localtime:ro
    environment:
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
      TZ: Asia/Ho_Chi_Minh #Them dong nay
    command: 
      - --config.file=/etc/tempo/tempo-config.yaml
    depends_on:
      - minio
      - init-minio # Thêm phụ thuộc vào service khởi tạo
    restart: unless-stopped
    networks:
      - observ-net
    
  # 5. AGENT: Grafana Alloy (Collector/Agent)
  alloy:
    image: grafana/alloy:latest
    container_name: alloy
    ports:
      - "12345:12345" # Cổng Alloy API/UI/Metrics
    volumes:
      # Ánh xạ cấu hình Alloy
      - ./config/alloy-config.alloy:/etc/alloy/config.alloy
      # Tùy chọn: Volume cho dữ liệu Alloy (lưu trạng thái/logs cục bộ)
      - alloy_data:/var/lib/alloy/data
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command:
      - run
      - --server.http.listen-addr=0.0.0.0:12345
      - --storage.path=/var/lib/alloy/data
      - /etc/alloy/config.alloy
    depends_on:
      - mimir
      - loki
      - tempo
    restart: unless-stopped
    networks:
      - observ-net
    environment:
      - TZ=Asia/Ho_Chi_Minh # Thêm dòng này
  # 6. FRONTEND: Grafana (Giao diện người dùng)
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000" # Cổng giao diện web Grafana
    volumes:
      - grafana_data:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_FEATURE_TOGGLES_ENABLE=traceqlEditor,traceToMetrics,publicDashboards,appObservability # Bật tính năng APM chuyên dụng
      - TZ=Asia/Ho_Chi_Minh
      
    depends_on:
      - mimir
      - loki
      - tempo
    restart: unless-stopped
    networks:
      - observ-net
  # 7. APPLICATION TESTER: Tạo Logs, Metrics, và Traces liên tục
  python-app:
      build: ./python-app
      container_name: python-app
      ports:
        - "8000:8000"
      environment:
        - TZ=Asia/Ho_Chi_Minh
        - OTEL_SERVICE_NAME=python-app
        - OTEL_EXPORTER_OTLP_ENDPOINT=http://alloy:4317
        - OTEL_EXPORTER_OTLP_PROTOCOL=grpc # Thêm để ổn định
      depends_on:
        - alloy
      networks:
        - observ-net
  nodejs-app:
      build: ./nodejs-app
      container_name: nodejs-app
      environment:
        - OTEL_SERVICE_NAME=nodejs-app
        - OTEL_EXPORTER_OTLP_ENDPOINT=http://alloy:4318 # Dùng cổng HTTP của Alloy
        - TZ=Asia/Ho_Chi_Minh
      networks:
        - observ-net
      depends_on:
        - alloy

  java-app:
      build: ./java-app
      container_name: java-app
      environment:
        - OTEL_SERVICE_NAME=java-app
        - OTEL_EXPORTER_OTLP_ENDPOINT=http://alloy:4317 # Java thường dùng gRPC (4317)
        - OTEL_EXPORTER_OTLP_PROTOCOL=grpc    # THÊM DÒNG NÀY
        - OTEL_TRACES_EXPORTER=otlp        # Đảm bảo exporter trace được bật
        - OTEL_METRICS_EXPORTER=otlp
        - OTEL_LOGS_EXPORTER=otlp
        - TZ=Asia/Ho_Chi_Minh

      networks:
        - observ-net
      depends_on:
        - alloy
# Định nghĩa mạng và volumes
networks:
  observ-net:
    driver: bridge

volumes:
  minio_data:
  alloy_data:
  grafana_data: